<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoFi Music Empire - Complete Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: #f5f5f5;
            color: #666;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #e8e8e8;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group select,
        .form-group input[type="number"],
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        /* Progress */
        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .progress-text {
            color: #666;
            font-size: 0.9rem;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-zone.dragover {
            background: #667eea;
            color: white;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        /* File List */
        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-item-name {
            font-weight: 500;
            color: #333;
        }

        .file-item-meta {
            font-size: 0.85rem;
            color: #999;
        }

        .file-item button {
            padding: 6px 12px;
            border: none;
            background: #ff4444;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .file-item button:hover {
            background: #cc0000;
        }

        /* Track List */
        .track-list {
            display: grid;
            gap: 15px;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .track-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .track-icon {
            font-size: 2rem;
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .track-meta {
            font-size: 0.85rem;
            color: #999;
        }

        .track-actions {
            display: flex;
            gap: 8px;
        }

        .track-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn-download {
            background: #4CAF50;
            color: white;
        }

        .btn-delete {
            background: #ff4444;
            color: white;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Training Status */
        .training-status {
            padding: 15px;
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .training-status.training {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .training-status.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        .training-status.error {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        /* Grid Layouts */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéµ LoFi Music Empire</h1>
            <p>Complete AI-Powered Music Production & Training System</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('generation')">üéµ Generation</button>
            <button class="tab-button" onclick="switchTab('training')">üéì Training</button>
            <button class="tab-button" onclick="switchTab('batch')">‚ö° Batch Generation</button>
            <button class="tab-button" onclick="switchTab('library')">üìö Library</button>
            <button class="tab-button" onclick="switchTab('analytics')">üìä Analytics</button>
        </div>

        <!-- Generation Tab -->
        <div id="generation-tab" class="tab-content active">
            <div class="two-column">
                <div class="card">
                    <h2 class="card-title">Generate Track</h2>
                    <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                        Create a unique lo-fi track with custom settings. The system will compose music with proper chord progressions, bass lines, and melodies, then apply authentic lo-fi effects like vinyl crackle, bit crushing, and tape saturation.
                    </p>
                    <form id="generation-form">
                        <div class="form-group">
                            <label for="mood">Mood</label>
                            <small style="display: block; color: #999; margin-bottom: 5px;">
                                Controls the chord progression and overall feel of the track
                            </small>
                            <select name="mood" id="mood">
                                <option value="chill">Chill - Relaxed I-IV-vi-IV progression</option>
                                <option value="melancholic">Melancholic - Emotional minor progressions</option>
                                <option value="upbeat">Upbeat - Energetic I-vi-IV-V progression</option>
                                <option value="dreamy">Dreamy - Lush chords with 7th extensions</option>
                                <option value="relaxed">Relaxed - Smooth I-ii-IV-I progression</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="theme">Theme / Ambient</label>
                            <small style="display: block; color: #999; margin-bottom: 5px;">
                                Add atmospheric background sounds to enhance the mood
                            </small>
                            <select name="theme" id="theme">
                                <option value="plain">Plain (No ambient sounds)</option>
                                <option value="rain">Rain - Gentle rainfall ambience</option>
                                <option value="cafe">Caf√© - Coffee shop chatter and sounds</option>
                                <option value="urban_chill">Urban Chill - Distant traffic and city sounds</option>
                                <option value="nature">Nature - Forest birds and nature sounds</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="lofi_preset">LoFi Effect Intensity</label>
                            <small style="display: block; color: #999; margin-bottom: 5px;">
                                How much vintage/lo-fi character to add (vinyl crackle, wow/flutter, etc.)
                            </small>
                            <select name="lofi_preset" id="lofi_preset">
                                <option value="light">Light - Subtle vintage warmth</option>
                                <option value="medium" selected>Medium - Classic lo-fi sound</option>
                                <option value="heavy">Heavy - Maximum vintage character</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="key">Musical Key</label>
                            <small style="display: block; color: #999; margin-bottom: 5px;">
                                The root key of the composition (affects overall tonality)
                            </small>
                            <select name="key" id="key">
                                <option value="C">C Major</option>
                                <option value="Cm">C Minor</option>
                                <option value="D">D Major</option>
                                <option value="Dm">D Minor</option>
                                <option value="E">E Major</option>
                                <option value="Em">E Minor</option>
                                <option value="F">F Major</option>
                                <option value="Fm">F Minor</option>
                                <option value="G">G Major</option>
                                <option value="Gm">G Minor</option>
                                <option value="A">A Major</option>
                                <option value="Am" selected>A Minor (default)</option>
                                <option value="B">B Major</option>
                                <option value="Bm">B Minor</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="duration">Duration (seconds)</label>
                            <small style="display: block; color: #999; margin-bottom: 5px;">
                                Length of the track (10-600 seconds, ~3 minutes recommended)
                            </small>
                            <input type="number" name="duration" id="duration" value="180" min="10" max="600">
                        </div>

                        <button type="submit" class="btn btn-primary" id="generate-btn">
                            üéµ Generate Track
                        </button>
                    </form>

                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill">0%</div>
                        </div>
                        <div class="progress-text" id="progress-text">Initializing...</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Quick Stats</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                        Overview of your music generation activity
                    </p>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-tracks">0</div>
                            <div class="stat-label">Total Tracks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-duration">0m</div>
                            <div class="stat-label">Total Duration</div>
                        </div>
                    </div>

                    <h3 class="card-title" style="margin-top: 20px;">Recent Generations</h3>
                    <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">
                        Your last 3 generated tracks
                    </p>
                    <div id="recent-tracks"></div>
                </div>
            </div>
        </div>

        <!-- Training Tab -->
        <div id="training-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">AI Model Training</h2>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    Train the AI model on your own MIDI files to teach it your unique musical style. The more diverse and high-quality MIDI files you provide, the better the AI will learn to generate music in your style.
                </p>
                <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>üí° How it works:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Upload your MIDI files (at least 10-20 for good results)</li>
                        <li>System tokenizes the MIDI data into musical patterns</li>
                        <li>AI learns chord progressions, melodies, and rhythms from your music</li>
                        <li>After training, generated tracks will reflect your musical style</li>
                    </ul>
                </div>

                <div class="training-status" id="training-status">
                    <strong>Status:</strong> <span id="training-status-text">Ready to train</span>
                </div>

                <h3 class="card-title">Step 1: Upload Training Data (MIDI Files)</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                    Drag and drop multiple MIDI files or click to browse. These files will be analyzed to teach the AI your musical patterns and style.
                </p>
                <div class="upload-zone" id="training-upload-zone">
                    <input type="file" id="training-file-input" style="display: none;" accept=".mid,.midi" multiple>
                    <div class="upload-icon">üéπ</div>
                    <div class="upload-text">Drag & Drop MIDI files here</div>
                    <div class="upload-hint">or click to browse</div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #999;">
                        Accepted: .mid, .midi files | Upload 10+ files for best results
                    </div>
                </div>

                <div class="file-list" id="training-file-list"></div>

                <h3 class="card-title" style="margin-top: 30px;">Step 2: Configure Training Parameters</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                    Adjust these settings based on your needs. Default values work well for most cases.
                </p>
                <form id="training-form">
                    <div class="form-group">
                        <label for="epochs">Number of Epochs</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            How many times to iterate through the training data (more epochs = better learning, but slower)
                        </small>
                        <input type="number" name="epochs" id="epochs" value="10" min="1" max="100">
                    </div>

                    <div class="form-group">
                        <label for="batch_size">Batch Size</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            Number of samples processed together (larger = faster, but uses more memory)
                        </small>
                        <input type="number" name="batch_size" id="batch_size" value="8" min="1" max="64">
                    </div>

                    <div class="form-group">
                        <label for="learning_rate">Learning Rate</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            How quickly the model learns (0.0001 is a safe default, smaller = more stable)
                        </small>
                        <input type="number" name="learning_rate" id="learning_rate" value="0.0001" step="0.00001" min="0.00001" max="0.01">
                    </div>

                    <button type="submit" class="btn btn-primary" id="train-btn">
                        üöÄ Start Training
                    </button>
                </form>

                <div class="progress-container" id="training-progress-container">
                    <h3 class="card-title">Training Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="training-progress-fill">0%</div>
                    </div>
                    <div class="progress-text" id="training-progress-text">Not started</div>
                    <div style="margin-top: 15px;">
                        <strong>Current Epoch:</strong> <span id="training-epoch">0/0</span><br>
                        <strong>Loss:</strong> <span id="training-loss">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Generation Tab -->
        <div id="batch-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Batch Generation</h2>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    Generate multiple lo-fi tracks in one go - perfect for creating albums, playlists, or building up your music library quickly. All tracks will automatically appear in your Library tab.
                </p>
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>‚ö° Batch Benefits:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Save time by generating multiple tracks automatically</li>
                        <li>Create variety with random mood selection</li>
                        <li>Build a complete album or playlist in minutes</li>
                        <li>All tracks are saved with unique metadata</li>
                    </ul>
                </div>

                <form id="batch-form">
                    <div class="form-group">
                        <label for="batch-count">Number of Tracks</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            How many tracks to generate (1-50). Each track processes sequentially.
                        </small>
                        <input type="number" name="count" id="batch-count" value="5" min="1" max="50">
                    </div>

                    <div class="form-group">
                        <label for="batch-mood">Mood Selection</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            Choose 'Random' for variety, or select a specific mood for consistency
                        </small>
                        <select name="mood" id="batch-mood">
                            <option value="random">Random - Mix of all moods for variety</option>
                            <option value="chill">Chill - All tracks will be relaxed</option>
                            <option value="melancholic">Melancholic - All tracks will be emotional</option>
                            <option value="upbeat">Upbeat - All tracks will be energetic</option>
                            <option value="dreamy">Dreamy - All tracks will be lush</option>
                            <option value="relaxed">Relaxed - All tracks will be smooth</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="batch-duration">Duration per Track (seconds)</label>
                        <small style="display: block; color: #999; margin-bottom: 5px;">
                            Length for each track (180 seconds = 3 minutes, typical for lo-fi)
                        </small>
                        <input type="number" name="duration" id="batch-duration" value="180" min="10" max="600">
                    </div>

                    <button type="submit" class="btn btn-primary" id="batch-btn">
                        ‚ö° Generate Batch
                    </button>
                    <p style="color: #999; margin-top: 10px; font-size: 0.9rem;">
                        ‚è±Ô∏è Estimated time: ~30-60 seconds per track
                    </p>
                </form>

                <div class="progress-container" id="batch-progress-container">
                    <h3 class="card-title">Batch Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="batch-progress-fill">0%</div>
                    </div>
                    <div class="progress-text" id="batch-progress-text">Not started</div>
                    <div style="margin-top: 15px;">
                        <strong>Completed:</strong> <span id="batch-completed">0</span> / <span id="batch-total">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Tab -->
        <div id="library-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Track Library</h2>
                <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                    View all your generated tracks in one place. Download your favorites as WAV files or delete tracks you don't need. Each track includes full metadata with mood, duration, and file size information.
                </p>
                <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem;">
                    <strong>üìö Library Features:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                        <li><strong>Download:</strong> Get WAV files for use in other software</li>
                        <li><strong>Metadata:</strong> Each track shows mood, duration, and file size</li>
                        <li><strong>Management:</strong> Delete tracks you don't want to keep</li>
                        <li><strong>Auto-refresh:</strong> New tracks appear automatically</li>
                    </ul>
                </div>
                <div class="track-list" id="track-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéµ</div>
                        <p>No tracks yet. Generate your first track!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Analytics Dashboard</h2>
                <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                    Track your music generation activity with detailed statistics. See how many tracks you've created, total audio time produced, and breakdown by mood to understand your creative patterns.
                </p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="analytics-total-tracks">0</div>
                        <div class="stat-label">Total Tracks Generated</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analytics-total-time">0h</div>
                        <div class="stat-label">Total Audio Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analytics-avg-duration">0s</div>
                        <div class="stat-label">Avg Track Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analytics-models-trained">0</div>
                        <div class="stat-label">Models Trained</div>
                    </div>
                </div>

                <h3 class="card-title" style="margin-top: 20px;">Generation by Mood</h3>
                <div id="mood-breakdown"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for tab
            if (tabName === 'library') {
                loadTracks();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'training') {
                loadTrainingStatus();
            }
        }

        // Generation Form
        let statusCheckInterval;

        document.getElementById('generation-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const settings = {};
            formData.forEach((value, key) => settings[key] = value);

            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            document.getElementById('progress-container').classList.add('active');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    startStatusCheck();
                } else {
                    alert('Failed to start generation');
                    btn.disabled = false;
                    btn.textContent = 'üéµ Generate Track';
                }
            } catch (error) {
                alert('Error: ' + error);
                btn.disabled = false;
                btn.textContent = 'üéµ Generate Track';
            }
        });

        function startStatusCheck() {
            statusCheckInterval = setInterval(checkStatus, 500);
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const btn = document.getElementById('generate-btn');

                progressFill.style.width = status.progress + '%';
                progressFill.textContent = status.progress + '%';
                progressText.textContent = status.current_step;

                if (!status.is_generating) {
                    clearInterval(statusCheckInterval);

                    if (status.error) {
                        alert('Error: ' + status.error);
                    } else if (status.progress === 100) {
                        console.log('Generation complete! Refreshing track list...');
                        loadTracks();
                        loadRecentTracks();
                        updateStats();
                        setTimeout(() => {
                            document.getElementById('progress-container').classList.remove('active');
                            progressFill.style.width = '0%';
                            progressFill.textContent = '0%';
                        }, 2000);
                    }

                    btn.disabled = false;
                    btn.textContent = 'üéµ Generate Track';
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        // Track Library
        async function loadTracks() {
            try {
                console.log('Loading tracks...');
                const response = await fetch('/api/tracks');
                const tracks = await response.json();
                console.log('Loaded tracks:', tracks);

                const trackList = document.getElementById('track-list');

                if (tracks.length === 0) {
                    trackList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéµ</div>
                            <p>No tracks yet. Generate your first track!</p>
                        </div>
                    `;
                } else {
                    trackList.innerHTML = tracks.map(track => `
                        <div class="track-item">
                            <div class="track-icon">üéµ</div>
                            <div class="track-info">
                                <div class="track-title">${track.title || track.filename}</div>
                                <div class="track-meta">
                                    ${track.mood || 'Unknown mood'} ‚Ä¢
                                    ${Math.round(track.duration || 0)}s ‚Ä¢
                                    ${(track.size / 1024 / 1024).toFixed(2)} MB
                                </div>
                            </div>
                            <div class="track-actions">
                                <button class="btn-download" onclick="downloadTrack('${track.id}')">
                                    ‚¨áÔ∏è Download
                                </button>
                                <button class="btn-delete" onclick="deleteTrack('${track.id}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading tracks:', error);
            }
        }

        async function loadRecentTracks() {
            try {
                const response = await fetch('/api/tracks');
                const tracks = await response.json();

                const recentTracks = tracks.slice(0, 3);
                const recentContainer = document.getElementById('recent-tracks');

                if (recentTracks.length === 0) {
                    recentContainer.innerHTML = '<p style="color: #999; text-align: center;">No tracks yet</p>';
                } else {
                    recentContainer.innerHTML = recentTracks.map(track => `
                        <div class="file-item">
                            <div>
                                <div class="file-item-name">${track.title || track.filename}</div>
                                <div class="file-item-meta">${track.mood} ‚Ä¢ ${Math.round(track.duration || 0)}s</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent tracks:', error);
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/tracks');
                const tracks = await response.json();

                const totalTracks = tracks.length;
                const totalDuration = tracks.reduce((sum, track) => sum + (track.duration || 0), 0);

                document.getElementById('total-tracks').textContent = totalTracks;
                document.getElementById('total-duration').textContent = Math.round(totalDuration / 60) + 'm';
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        async function downloadTrack(trackId) {
            window.location.href = `/api/download/${trackId}`;
        }

        async function deleteTrack(trackId) {
            if (!confirm('Are you sure you want to delete this track?')) return;

            try {
                await fetch(`/api/delete/${trackId}`, {method: 'DELETE'});
                loadTracks();
                updateStats();
            } catch (error) {
                alert('Error deleting track: ' + error);
            }
        }

        // Training Functions
        const trainingUploadZone = document.getElementById('training-upload-zone');
        const trainingFileInput = document.getElementById('training-file-input');
        const trainingFileList = document.getElementById('training-file-list');

        trainingUploadZone.addEventListener('click', () => {
            trainingFileInput.click();
        });

        trainingUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            trainingUploadZone.classList.add('dragover');
        });

        trainingUploadZone.addEventListener('dragleave', () => {
            trainingUploadZone.classList.remove('dragover');
        });

        trainingUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            trainingUploadZone.classList.remove('dragover');
            handleTrainingFiles(e.dataTransfer.files);
        });

        trainingFileInput.addEventListener('change', (e) => {
            handleTrainingFiles(e.target.files);
        });

        async function handleTrainingFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.mid') || file.name.endsWith('.midi')) {
                    await uploadTrainingFile(file);
                }
            }
            loadTrainingFiles();
        }

        async function uploadTrainingFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                await fetch('/api/upload/training', {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Upload error:', error);
            }
        }

        async function loadTrainingFiles() {
            try {
                const response = await fetch('/api/training/files');
                const files = await response.json();

                if (files.length === 0) {
                    trainingFileList.innerHTML = '<p style="color: #999; text-align: center; margin-top: 15px;">No training files uploaded yet</p>';
                } else {
                    trainingFileList.innerHTML = files.map(file => `
                        <div class="file-item">
                            <div>
                                <div class="file-item-name">${file.original_name}</div>
                                <div class="file-item-meta">${(file.size / 1024).toFixed(2)} KB</div>
                            </div>
                            <button onclick="deleteTrainingFile('${file.filename}')">üóëÔ∏è Delete</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading training files:', error);
            }
        }

        async function deleteTrainingFile(filename) {
            try {
                await fetch(`/api/training/files/${filename}`, {method: 'DELETE'});
                loadTrainingFiles();
            } catch (error) {
                alert('Error deleting file: ' + error);
            }
        }

        async function loadTrainingStatus() {
            try {
                const response = await fetch('/api/training/status');
                const status = await response.json();

                const statusEl = document.getElementById('training-status');
                const statusText = document.getElementById('training-status-text');

                statusEl.className = 'training-status';
                if (status.is_training) {
                    statusEl.classList.add('training');
                    statusText.textContent = `Training in progress - Epoch ${status.epoch}/${status.total_epochs}`;
                } else if (status.last_trained) {
                    statusEl.classList.add('completed');
                    statusText.textContent = `Last trained: ${status.last_trained}`;
                } else {
                    statusText.textContent = 'Ready to train';
                }
            } catch (error) {
                console.error('Error loading training status:', error);
            }
        }

        document.getElementById('training-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {};
            formData.forEach((value, key) => config[key] = value);

            const btn = document.getElementById('train-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Training...';

            try {
                const response = await fetch('/api/training/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    document.getElementById('training-progress-container').classList.add('active');
                    startTrainingStatusCheck();
                } else {
                    alert('Failed to start training');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Start Training';
                }
            } catch (error) {
                alert('Error: ' + error);
                btn.disabled = false;
                btn.textContent = 'üöÄ Start Training';
            }
        });

        let trainingStatusInterval;

        function startTrainingStatusCheck() {
            trainingStatusInterval = setInterval(checkTrainingStatus, 1000);
        }

        async function checkTrainingStatus() {
            try {
                const response = await fetch('/api/training/status');
                const status = await response.json();

                const progressFill = document.getElementById('training-progress-fill');
                const progressText = document.getElementById('training-progress-text');
                const epochText = document.getElementById('training-epoch');
                const lossText = document.getElementById('training-loss');
                const btn = document.getElementById('train-btn');

                if (status.is_training) {
                    const progress = (status.epoch / status.total_epochs) * 100;
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = Math.round(progress) + '%';
                    progressText.textContent = status.status || 'Training...';
                    epochText.textContent = `${status.epoch}/${status.total_epochs}`;
                    lossText.textContent = status.loss ? status.loss.toFixed(4) : '-';
                } else {
                    clearInterval(trainingStatusInterval);
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Start Training';

                    if (status.error) {
                        alert('Training error: ' + status.error);
                    } else {
                        alert('Training completed successfully!');
                    }
                }
            } catch (error) {
                console.error('Training status check error:', error);
            }
        }

        // Analytics
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/tracks');
                const tracks = await response.json();

                const totalTracks = tracks.length;
                const totalTime = tracks.reduce((sum, t) => sum + (t.duration || 0), 0);
                const avgDuration = totalTracks > 0 ? totalTime / totalTracks : 0;

                document.getElementById('analytics-total-tracks').textContent = totalTracks;
                document.getElementById('analytics-total-time').textContent = (totalTime / 3600).toFixed(1) + 'h';
                document.getElementById('analytics-avg-duration').textContent = Math.round(avgDuration) + 's';

                // Mood breakdown
                const moodCounts = {};
                tracks.forEach(track => {
                    const mood = track.mood || 'unknown';
                    moodCounts[mood] = (moodCounts[mood] || 0) + 1;
                });

                const moodBreakdown = document.getElementById('mood-breakdown');
                moodBreakdown.innerHTML = Object.entries(moodCounts)
                    .map(([mood, count]) => `
                        <div class="file-item">
                            <div>
                                <div class="file-item-name">${mood}</div>
                                <div class="file-item-meta">${count} tracks</div>
                            </div>
                        </div>
                    `).join('');

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Batch Generation
        document.getElementById('batch-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {};
            formData.forEach((value, key) => config[key] = value);

            const btn = document.getElementById('batch-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            document.getElementById('batch-progress-container').classList.add('active');

            try {
                const response = await fetch('/api/batch/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    startBatchStatusCheck();
                } else {
                    alert('Failed to start batch generation');
                    btn.disabled = false;
                    btn.textContent = '‚ö° Generate Batch';
                }
            } catch (error) {
                alert('Error: ' + error);
                btn.disabled = false;
                btn.textContent = '‚ö° Generate Batch';
            }
        });

        let batchStatusInterval;

        function startBatchStatusCheck() {
            batchStatusInterval = setInterval(checkBatchStatus, 1000);
        }

        async function checkBatchStatus() {
            try {
                const response = await fetch('/api/batch/status');
                const status = await response.json();

                const progressFill = document.getElementById('batch-progress-fill');
                const progressText = document.getElementById('batch-progress-text');
                const completedEl = document.getElementById('batch-completed');
                const totalEl = document.getElementById('batch-total');
                const btn = document.getElementById('batch-btn');

                progressFill.style.width = status.progress + '%';
                progressFill.textContent = status.progress + '%';
                progressText.textContent = status.status || 'Processing...';
                completedEl.textContent = status.completed;
                totalEl.textContent = status.total;

                if (!status.is_generating) {
                    clearInterval(batchStatusInterval);
                    btn.disabled = false;
                    btn.textContent = '‚ö° Generate Batch';

                    if (status.error) {
                        alert('Batch generation error: ' + status.error);
                    } else {
                        alert('Batch generation completed!');
                        loadTracks();
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('Batch status check error:', error);
            }
        }

        // Initialize
        loadTracks();
        loadRecentTracks();
        updateStats();
        setInterval(loadTracks, 10000);
    </script>
</body>
</html>
